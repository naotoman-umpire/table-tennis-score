<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Table Tennis Scoreboard</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:green; display:flex; justify-content:center; align-items:flex-start; min-height:100vh; }
.overlay { background: rgba(255,255,255,0.95); border-radius:12px; padding:15px; margin:10px; width:900px; text-align:center; }
.tabs { display:flex; margin-bottom:10px; }
.tab { padding:10px 20px; border:1px solid #ccc; cursor:pointer; margin-right:5px; border-radius:8px 8px 0 0; background:#f0f0f0; }
.tab.active { background:#fff; border-bottom:none; font-weight:bold; }
.tab-content { border:1px solid #ccc; padding:20px; border-radius:0 8px 8px 8px; display:none; }
.tab-content.active { display:block; }
.players { display:flex; justify-content:space-around; }
.player { text-align:center; width:40%; position:relative; }
.player-score { display:flex; align-items:center; justify-content:center; }
.score { font-size:7em; margin:10px; }
.serve { font-size:3em; margin-left:10px; } 
button { font-size:1em; margin:5px; padding:8px 16px; }
.cards { margin-top:10px; display:flex; justify-content:center; }
.cards span { display:inline-block; width:25px; height:35px; margin:2px; border-radius:4px; }
.cards .timeout { background:#ffffff; border:1px solid #ccc; }
.cards .yellow { background:#FFD700; }
.cards .red { background:#FF0000; }
.status { font-size:1.5em; font-weight:bold; color:orange; margin-top:10px; }
#winner { font-size:2em; margin-top:20px; text-align:center; color:green; }
#history { margin-top:20px; font-size:0.9em; background:#fff; padding:10px; border-radius:8px; max-height:150px; overflow-y:auto; }
.point-btn { font-size:1.5em; padding:12px 24px; font-weight:bold; background-color:#ffeb3b; border-radius:8px; }
#timerDisplay { font-size:3em; font-weight:bold; color:red; text-align:center; margin:10px 0; }
#timerControls { text-align:center; display:none; margin-bottom:10px; }
#timerControls button { margin:5px; }
#clearTimerBtn { display:none; font-size:1em; padding:8px 16px; background:#f44336; color:white; border:none; border-radius:6px; }
#startScreen, #positionScreen { display:flex; flex-direction:column; justify-content:center; align-items:center; min-height:80vh; }
#startScreen button, #positionScreen button { font-size:2em; padding:20px 40px; margin:10px; }

/* サーブレット中央下部配置 */
#serveLetContainer { margin-top:20px; display:flex; justify-content:center; align-items:center; gap:20px; }
#serveLetContainer button {
    font-size: 1.2em;
    padding: 20px;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    justify-content: center;
    align-items: center;
    background-color: #ffeb3b;
    border: none;
    cursor: pointer;
}
#serveLetContainer button:hover { background-color: #ffd700; }
#playingTimerDisplay { font-size:1em; color:blue; min-width:80px; text-align:left; margin-left:10px; }
</style>
</head>
<body>

<!-- サーブ選択画面 -->
<div class="overlay" id="startScreen">
  <h1>SELECT FIRST SERVER</h1>
  <button onclick="selectServer('A')">PLAYER A</button>
  <button onclick="selectServer('B')">PLAYER B</button>
</div>

<!-- 左右選択画面 -->
<div class="overlay" id="positionScreen" style="display:none;">
  <h1>SELECT PLAYER ON LEFT</h1>
  <button onclick="selectPosition('A')">PLAYER A LEFT</button>
  <button onclick="selectPosition('B')">PLAYER B LEFT</button>
  <button onclick="backToServerSelection()">BACK</button>
</div>

<!-- メイン画面 -->
<div class="overlay" id="mainScreen" style="display:none;">
<h2>⚪ TABLE TENNIS SCOREBOARD</h2>

<div id="timerDisplay"></div>
<div id="timerControls">
  <button onclick="startTimer()">START TIMER</button>
  <button onclick="stopTimer()">STOP TIMER</button>
  <button onclick="resetTimer()">RESET TIMER</button>
</div>
<button id="clearTimerBtn" onclick="forceEndTimer()">CLEAR TIMER</button>

<div style="margin:10px 0;">
  <button onclick="prepareTimer('WARM UP')">SET WARM UP (120s)</button>
  <button onclick="prepareTimer('WATER BREAK')">SET WATER BREAK (60s)</button>
</div>

<div>
  Match Type: 
  <select id="matchType" onchange="setMatchType()">
    <option value="3">3 Games (Best of 5)</option>
    <option value="4">4 Games (Best of 7)</option>
  </select>
  &nbsp;&nbsp; First Server:
  <span id="firstServerDisplay"></span>
  <button onclick="setPosition()" style="font-size:0.9em;">SET POSITION</button>
  <button onclick="correctServer()" style="font-size:0.9em;">CHANGE FIRST SERVER</button>
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('scoreTab', event)">Score & Timeout</div>
  <div class="tab" onclick="showTab('cardsTab', event)">Cards</div>
</div>

<div id="scoreTab" class="tab-content active">
  <div class="players" id="court">
    <div class="player" id="playerA">
      <h2>PLAYER A</h2>
      <div class="player-score"><span id="scoreA" class="score">0</span><span id="serveA" class="serve"></span></div>
      <div><span id="pointAStatus" class="status"></span></div>
      <div>Games: <span id="gamesA">0</span></div>
      <button class="point-btn" onclick="addPoint('A')">+1 POINT</button>
      <button onclick="removePoint('A')">-1 POINT</button><br>
      <button onclick="timeout('A')">TIMEOUT</button>
      <button onclick="removeCard('A','timeout')">UNDO TIMEOUT</button>
      <div class="cards" id="cardsA"></div>
    </div>
    <div class="player" id="playerB">
      <h2>PLAYER B</h2>
      <div class="player-score"><span id="scoreB" class="score">0</span><span id="serveB" class="serve"></span></div>
      <div><span id="pointBStatus" class="status"></span></div>
      <div>Games: <span id="gamesB">0</span></div>
      <button class="point-btn" onclick="addPoint('B')">+1 POINT</button>
      <button onclick="removePoint('B')">-1 POINT</button><br>
      <button onclick="timeout('B')">TIMEOUT</button>
      <button onclick="removeCard('B','timeout')">UNDO TIMEOUT</button>
      <div class="cards" id="cardsB"></div>
    </div>
  </div>
  <div id="winner"></div>
  <button onclick="nextGame()">NEXT GAME</button>
  <button onclick="resetMatch()">RESET MATCH</button>
  <button onclick="undo()">UNDO LAST ACTION</button>

  <!-- サーブ・レット丸ボタン + プレイングタイマー -->
  <div id="serveLetContainer">
    <button onclick="servePoint()">SERVE</button>
    <button onclick="letPoint()">LET</button>
    <span id="playingTimerDisplay">0.0s</span>
  </div>

</div>

<div id="cardsTab" class="tab-content">
  <h3>CARD MANAGEMENT</h3>
  <div class="players">
    <div class="player">
      <h2>PLAYER A</h2>
      <button onclick="card('A','yellow')">ADD YELLOW</button>
      <button onclick="removeCard('A','yellow')">REMOVE YELLOW</button><br>
      <button onclick="card('A','red')">ADD RED</button>
      <button onclick="removeCard('A','red')">REMOVE RED</button>
    </div>
    <div class="player">
      <h2>PLAYER B</h2>
      <button onclick="card('B','yellow')">ADD YELLOW</button>
      <button onclick="removeCard('B','yellow')">REMOVE YELLOW</button><br>
      <button onclick="card('B','red')">ADD RED</button>
      <button onclick="removeCard('B','red')">REMOVE RED</button>
    </div>
  </div>
</div>

<div id="history">
  <h4>GAME HISTORY</h4>
  <ul id="historyList"></ul>
</div>

<script>
// ----------------------------
// 変数
let scoreA=0,scoreB=0,gamesA=0,gamesB=0,firstServer='A',serveTurn='A',GAMES_TO_WIN=3,gameNumber=1;
let cardCount={A:{yellow:0,red:0,timeout:0},B:{yellow:0,red:0,timeout:0}};
let historyStack=[];
let timerInterval=null,timerSeconds=0,timerLabel="";
let leftPlayer='A', rightPlayer='B';
let playingSeconds=0, playingTimerInterval=null;

// ----------------------------
// サーブ/左右選択
function selectServer(player){ firstServer=player; document.getElementById('startScreen').style.display='none'; document.getElementById('positionScreen').style.display='flex'; }
function backToServerSelection(){ document.getElementById('positionScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }
function selectPosition(playerOnLeft){ leftPlayer=playerOnLeft; rightPlayer=(playerOnLeft==='A')?'B':'A'; document.getElementById('positionScreen').style.display='none'; document.getElementById('mainScreen').style.display='block'; updatePlayerPositions(); document.getElementById('firstServerDisplay').innerText=firstServer; updateServer(); }
function setPosition(){ document.getElementById('positionScreen').style.display='flex'; document.getElementById('mainScreen').style.display='none'; }
function correctServer(){ document.getElementById('mainScreen').style.display='none'; document.getElementById('positionScreen').style.display='none'; document.getElementById('startScreen').style.display='flex'; }
function updatePlayerPositions(){ const court=document.getElementById('court'); court.appendChild(document.getElementById('player'+leftPlayer)); court.appendChild(document.getElementById('player'+rightPlayer)); }

// ----------------------------
// タイマー
function prepareTimer(type){ timerLabel = type; if(type==="WARM UP") timerSeconds=120; else if(type==="WATER BREAK") timerSeconds=60; else if(type==="TIMEOUT") timerSeconds=60; updateTimerDisplay(); showTimerButtons(true); document.getElementById('clearTimerBtn').style.display="inline-block"; clearInterval(timerInterval); if(type==="TIMEOUT"){ timerInterval = setInterval(()=>{ if(timerSeconds>0){ timerSeconds--; updateTimerDisplay(); } else { forceEndTimer(); } },1000); } }
function showTimerButtons(show){ document.getElementById('timerControls').style.display=show?'block':'none'; }
function startTimer(){ clearInterval(timerInterval); timerInterval=setInterval(()=>{ if(timerSeconds>0){ timerSeconds--; updateTimerDisplay(); } else { clearInterval(timerInterval); } },1000); }
function stopTimer(){ clearInterval(timerInterval); }
function resetTimer(){ if(timerLabel==="WARM UP") timerSeconds=120; else timerSeconds=(timerLabel==="WATER BREAK")?60:60; updateTimerDisplay(); }
function forceEndTimer(){ clearInterval(timerInterval); timerSeconds=0; timerLabel=""; document.getElementById('timerDisplay').innerText=""; showTimerButtons(false); document.getElementById('clearTimerBtn').style.display="none"; }
function updateTimerDisplay(){ document.getElementById('timerDisplay').innerText=`${timerLabel} ${timerSeconds}s`; }

// ----------------------------
// タブ切替
function showTab(tabId, event){ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); event.target.classList.add('active'); document.getElementById(tabId).classList.add('active'); }

// ----------------------------
// ポイント・ゲーム
function saveState(){ historyStack.push({scoreA,scoreB,gamesA,gamesB,cardCount:JSON.parse(JSON.stringify(cardCount))}); }
function undo(){ if(historyStack.length>0){ let last=historyStack.pop(); scoreA=last.scoreA; scoreB=last.scoreB; gamesA=last.gamesA; gamesB=last.gamesB; cardCount=last.cardCount; updateScores(); updateCards('A'); updateCards('B'); document.getElementById('gamesA').innerText=gamesA; document.getElementById('gamesB').innerText=gamesB; updatePointStatus(); } }
function addPoint(player){ saveState(); if(isGameFinished()) return; if(player==='A') scoreA++; else scoreB++; updateScores(); updateServer(); updatePointStatus(); stopPlayingTimer(); }
function removePoint(player){ saveState(); if(player==='A' && scoreA>0) scoreA--; if(player==='B' && scoreB>0) scoreB--; updateScores(); updateServer(); updatePointStatus(); stopPlayingTimer(); }
function updateScores(){ document.getElementById('scoreA').innerText=scoreA; document.getElementById('scoreB').innerText=scoreB; }
function isGameFinished(){ return ((scoreA>=11||scoreB>=11)&&Math.abs(scoreA-scoreB)>=2); }
function updateServer(){ if(isGameFinished()){ document.getElementById('serveA').innerText=""; document.getElementById('serveB').innerText=""; return; } let total=scoreA+scoreB; if(scoreA>=10 && scoreB>=10){ serveTurn=(total%2===0)?firstServer:(firstServer==='A'?'B':'A'); } else { serveTurn=(Math.floor(total/2)%2===0)?firstServer:(firstServer==='A'?'B':'A'); } document.getElementById('serveA').innerText=(serveTurn==='A')?"🔴":""; document.getElementById('serveB').innerText=(serveTurn==='B')?"🔴":""; }
function updatePointStatus(){ let statusA="", statusB=""; if(scoreA>=10 && scoreA>scoreB && !isGameFinished()) statusA="GAME POINT"; if(scoreB>=10 && scoreB>scoreA && !isGameFinished()) statusB="GAME POINT"; if(gamesA===GAMES_TO_WIN-1 && scoreA>=10 && !isGameFinished()) statusA="MATCH POINT"; if(gamesB===GAMES_TO_WIN-1 && scoreB>=10 && !isGameFinished()) statusB="MATCH POINT"; document.getElementById('pointAStatus').innerText=statusA; document.getElementById('pointBStatus').innerText=statusB; }

// ----------------------------
// カード管理
function updateCards(player){ let el=(player==='A')?document.getElementById('cardsA'):document.getElementById('cardsB'); el.innerHTML=''; for(let i=0;i<cardCount[player].timeout;i++){ let span=document.createElement('span'); span.className='timeout'; el.appendChild(span); } for(let i=0;i<cardCount[player].yellow;i++){ let span=document.createElement('span'); span.className='yellow'; el.appendChild(span); } for(let i=0;i<cardCount[player].red;i++){ let span=document.createElement('span'); span.className='red'; el.appendChild(span); } }
function card(player,type){ saveState(); if(cardCount[player][type]!==undefined){ cardCount[player][type]++; updateCards(player); } }
function removeCard(player,type){ saveState(); if(cardCount[player][type] && cardCount[player][type]>0){ cardCount[player][type]--; updateCards(player); } }
function timeout(player){ prepareTimer('TIMEOUT'); card(player,'timeout'); }
function setMatchType(){ GAMES_TO_WIN=parseInt(document.getElementById("matchType").value); resetMatch(); }

// ----------------------------
// プレイングタイマー関連
function servePoint(){ stopPlayingTimer(); let lastTime = Date.now(); playingTimerInterval = setInterval(()=>{ const now = Date.now(); playingSeconds += (now-lastTime)/1000; lastTime = now; updatePlayingTimerDisplay(); }, 50); }
function letPoint(){ stopPlayingTimer(); }
function stopPlayingTimer(){ clearInterval(playingTimerInterval); updatePlayingTimerDisplay(); }
function updatePlayingTimerDisplay(){ const minutes=Math.floor(playingSeconds/60); const seconds=(playingSeconds%60).toFixed(1); document.getElementById('playingTimerDisplay').innerText = `${minutes}m${seconds}s`; }

// ----------------------------
// 次ゲーム
function nextGame(){
    if(!isGameFinished()){ timeout('A'); return; }
    saveState();
    if(scoreA>scoreB){ gamesA++; document.getElementById('gamesA').innerText=gamesA; } else { gamesB++; document.getElementById('gamesB').innerText=gamesB; }
    const li=document.createElement('li');
    li.innerText=`GAME ${gameNumber}: ${scoreA}-${scoreB}, WINNER ${scoreA>scoreB?'PLAYER A':'PLAYER B'}, FIRST SERVER ${firstServer}, TIME ${document.getElementById('playingTimerDisplay').innerText}`;
    document.getElementById('historyList').appendChild(li);
    playingSeconds=0; stopPlayingTimer();
    gameNumber++; scoreA=0; scoreB=0;
    firstServer=(firstServer==='A')?'B':'A';
    [leftPlayer,rightPlayer]=[rightPlayer,leftPlayer]; updatePlayerPositions();
    updateScores(); updateServer(); updatePointStatus();
}

// ----------------------------
// リセット（カードも初期化）
function resetMatch(){
  scoreA = 0; scoreB = 0; gamesA = 0; gamesB = 0; gameNumber = 1; 
  cardCount = {A:{yellow:0,red:0,timeout:0},B:{yellow:0,red:0,timeout:0}}; historyStack = []; playingSeconds=0; stopPlayingTimer();
  document.getElementById('gamesA').innerText = 0;
  document.getElementById('gamesB').innerText = 0;
  document.getElementById('scoreA').innerText = 0;
  document.getElementById('scoreB').innerText = 0;
  document.getElementById('historyList').innerHTML = ""; 
  document.getElementById('pointAStatus').innerText = "";
  document.getElementById('pointBStatus').innerText = "";
  document.getElementById('serveA').innerText = "";
  document.getElementById('serveB').innerText = "";
  updateCards('A'); updateCards('B'); forceEndTimer(); 
  document.getElementById('mainScreen').style.display = 'none'; document.getElementById('startScreen').style.display = 'flex';
}
</script>
</body>
</html>
